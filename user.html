<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ‘¤ Trang CÃ¡ NhÃ¢n - One Piece Bounty</title>
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/user.css">
</head>
<body>
  <div class="user-container">
    <!-- Header -->
    <header class="user-header">
      <div class="header-left">
        <a href="index.html" class="back-link">â† Quay láº¡i</a>
        <h1>ğŸ‘¤ TRANG CÃ NHÃ‚N</h1>
      </div>
      <div class="header-right">
        <button class="logout-btn" onclick="logout()">ğŸšª ÄÄƒng Xuáº¥t</button>
      </div>
    </header>

    <!-- User Info Section -->
    <main class="user-main">
      <!-- Profile Card -->
      <section class="profile-section">
        <div class="profile-card">
          <div class="profile-avatar-wrapper">
            <div class="profile-avatar" id="userAvatar">
              ğŸ‘¤
            </div>
            <button class="change-avatar-btn" onclick="openAvatarModal()" title="Äá»•i Avatar">
              ğŸ“·
            </button>
          </div>
          <div class="profile-info">
            <h2 id="userName">Äang táº£i...</h2>
            <p class="user-email" id="userEmail">...</p>
            <div class="user-badges">
              <span class="badge badge-role" id="userRole">User</span>
              <span class="badge badge-status" id="userStatus">Active</span>
            </div>
            <p class="user-joined">ğŸ“… Tham gia: <span id="userJoined">...</span></p>
          </div>
        </div>
      </section>

      <!-- Linked Pirate Section -->
      <section class="pirate-section">
        <h3>ğŸ´â€â˜ ï¸ Háº£i Táº·c Cá»§a Báº¡n</h3>
        <div class="linked-pirate" id="linkedPirate">
          <p class="no-pirate">Äang táº£i thÃ´ng tin...</p>
        </div>
      </section>

      <!-- Stats Section -->
      <section class="stats-section" id="pirateStats" style="display: none;">
        <h3>ğŸ“Š Thá»‘ng KÃª</h3>
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-icon">ğŸ’°</div>
            <div class="stat-value" id="statBounty">0à¸¿</div>
            <div class="stat-label">Tiá»n Truy NÃ£</div>
          </div>
          <div class="stat-item">
            <div class="stat-icon">ğŸ†</div>
            <div class="stat-value" id="statRank">-</div>
            <div class="stat-label">Cáº¥p Äá»™</div>
          </div>
          <div class="stat-item">
            <div class="stat-icon">âš”ï¸</div>
            <div class="stat-value" id="statCrew">-</div>
            <div class="stat-label">BÄƒng NhÃ³m</div>
          </div>
          <div class="stat-item">
            <div class="stat-icon">ğŸ“ˆ</div>
            <div class="stat-value" id="statRanking">-</div>
            <div class="stat-label">Xáº¿p Háº¡ng</div>
          </div>
        </div>
      </section>

      <!-- Quick Actions -->
      <section class="actions-section">
        <h3>âš¡ HÃ nh Äá»™ng Nhanh</h3>
        <div class="actions-grid">
          <a href="index.html" class="action-btn">
            <span class="action-icon">ğŸ </span>
            <span class="action-text">Trang Chá»§</span>
          </a>
          <button class="action-btn" onclick="viewLeaderboard()">
            <span class="action-icon">ğŸ…</span>
            <span class="action-text">Báº£ng Xáº¿p Háº¡ng</span>
          </button>
          <button class="action-btn" onclick="changePassword()">
            <span class="action-icon">ğŸ”‘</span>
            <span class="action-text">Äá»•i Máº­t Kháº©u</span>
          </button>
        </div>
      </section>
    </main>

    <!-- Footer -->
    <footer class="user-footer">
      <p>âš“ One Piece Bounty System</p>
    </footer>
  </div>

  <!-- Change Password Modal -->
  <div class="modal-overlay" id="changePasswordModal">
    <div class="modal">
      <div class="modal-header">
        <h3>ğŸ”‘ Äá»•i Máº­t Kháº©u</h3>
        <button class="close-btn" onclick="closeModal('changePasswordModal')">&times;</button>
      </div>
      <div class="modal-body">
        <form id="changePasswordForm" onsubmit="handleChangePassword(event)">
          <div class="form-group">
            <label>Máº­t kháº©u hiá»‡n táº¡i</label>
            <input type="password" id="currentPassword" required>
          </div>
          <div class="form-group">
            <label>Máº­t kháº©u má»›i</label>
            <input type="password" id="newPassword" required minlength="4">
          </div>
          <div class="form-group">
            <label>XÃ¡c nháº­n máº­t kháº©u má»›i</label>
            <input type="password" id="confirmPassword" required>
          </div>
          <p class="error-message" id="passwordError"></p>
          <div class="form-actions">
            <button type="button" class="btn-cancel" onclick="closeModal('changePasswordModal')">Há»§y</button>
            <button type="submit" class="btn-save">Äá»•i Máº­t Kháº©u</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Change Avatar Modal -->
  <div class="modal-overlay" id="changeAvatarModal">
    <div class="modal avatar-modal">
      <div class="modal-header">
        <h3>ğŸ“· Äá»•i Avatar</h3>
        <button class="close-btn" onclick="closeModal('changeAvatarModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="avatar-preview-container">
          <div class="avatar-preview" id="avatarPreview">ğŸ‘¤</div>
        </div>
        
        <div class="avatar-options">
          <div class="avatar-option-group">
            <h4>ğŸ“¤ Táº£i áº£nh lÃªn</h4>
            <input type="file" id="avatarFileInput" accept="image/*" onchange="previewAvatar(event)" style="display: none;">
            <button class="avatar-upload-btn" onclick="document.getElementById('avatarFileInput').click()">
              Chá»n áº£nh tá»« mÃ¡y
            </button>
          </div>
          
          <div class="avatar-option-group">
            <h4>ğŸ”— Hoáº·c nháº­p URL</h4>
            <input type="text" id="avatarUrlInput" placeholder="https://example.com/avatar.jpg" onchange="previewAvatarUrl()">
          </div>
        </div>
        
        <div class="form-actions">
          <button type="button" class="btn-cancel" onclick="closeModal('changeAvatarModal')">Há»§y</button>
          <button type="button" class="btn-save" onclick="saveAvatar()">LÆ°u Avatar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  
  <script src="js/pirates.js"></script>
  <script src="js/firebase-sync.js"></script>
  <script src="js/auth.js"></script>
  <script>
    // Kiá»ƒm tra Ä‘Äƒng nháº­p
    document.addEventListener('DOMContentLoaded', function() {
      const user = getCurrentUser();
      
      if (!user) {
        window.location.href = 'index.html';
        return;
      }
      
      loadUserProfile(user);
    });

    // Load thÃ´ng tin user
    function loadUserProfile(user) {
      // Láº¥y thÃ´ng tin rank tá»« pirate liÃªn káº¿t
      const pirates = JSON.parse(localStorage.getItem('onePiecePirates') || '[]');
      const linkedPirate = pirates.find(p => p.name === user.pirateId);
      let rankColor = '#f39c12'; // MÃ u máº·c Ä‘á»‹nh
      let rankType = ''; // Class rank
      
      if (linkedPirate) {
        const rank = getRankByBounty(linkedPirate.bounty);
        rankColor = rank.color;
        rankType = rank.type;
      }
      
      // ThÃ´ng tin cÆ¡ báº£n
      const userNameEl = document.getElementById('userName');
      userNameEl.textContent = user.username;
      userNameEl.className = rankType; // ThÃªm class rank cho gradient animation
      // Chá»‰ set mÃ u náº¿u khÃ´ng cÃ³ rank (fallback)
      if (!rankType) {
        userNameEl.style.color = rankColor;
        userNameEl.style.textShadow = `0 0 10px ${rankColor}40`;
      }
      
      document.getElementById('userEmail').textContent = user.email || 'ChÆ°a cÃ³ email';
      document.getElementById('userRole').textContent = user.role === 'admin' ? 'ğŸ‘‘ Admin' : 'ğŸ´â€â˜ ï¸ User';
      document.getElementById('userRole').className = 'badge badge-role ' + user.role;
      document.getElementById('userStatus').textContent = user.status === 'active' ? 'âœ… Hoáº¡t Ä‘á»™ng' : 'â¸ï¸ ' + user.status;
      document.getElementById('userJoined').textContent = user.createdAt || 'KhÃ´ng rÃµ';

      // Hiá»ƒn thá»‹ avatar - Æ°u tiÃªn láº¥y tá»« pirate liÃªn káº¿t
      const avatarEl = document.getElementById('userAvatar');
      if (linkedPirate && linkedPirate.image) {
        avatarEl.innerHTML = `<img src="${linkedPirate.image}" alt="Avatar">`;
      } else if (user.avatar) {
        avatarEl.innerHTML = `<img src="${user.avatar}" alt="Avatar">`;
      } else {
        avatarEl.textContent = user.role === 'admin' ? 'ğŸ‘‘' : 'ğŸ‘¤';
      }

      // Load thÃ´ng tin háº£i táº·c liÃªn káº¿t
      loadLinkedPirate(user);
    }

    // Load háº£i táº·c liÃªn káº¿t
    function loadLinkedPirate(user) {
      const pirateContainer = document.getElementById('linkedPirate');
      const statsSection = document.getElementById('pirateStats');
      const profileCard = document.querySelector('.profile-card');
      
      // Load pirates tá»« localStorage
      const savedPirates = localStorage.getItem('onePiecePirates');
      const pirates = savedPirates ? JSON.parse(savedPirates) : [];
      
      // TÃ¬m háº£i táº·c liÃªn káº¿t
      const pirate = pirates.find(p => p.name === user.pirateId);
      
      if (pirate) {
        const rank = getRankByBounty(pirate.bounty);
        const ranking = pirates.sort((a, b) => b.bounty - a.bounty).findIndex(p => p.name === pirate.name) + 1;
        
        // ThÃªm rank class vÃ o profile card
        if (profileCard) {
          profileCard.className = 'profile-card ' + rank.type;
        }
        
        // Hiá»ƒn thá»‹ thÃ´ng tin háº£i táº·c
        pirateContainer.innerHTML = `
          <div class="pirate-card ${rank.type}">
            <div class="pirate-avatar" id="pirateAvatarDisplay">
              ${pirate.image ? `<img src="${pirate.image}" alt="${pirate.name}">` : rank.icon}
            </div>
            <div class="pirate-info">
              <h4>${pirate.name}</h4>
              <p class="pirate-crew">âš”ï¸ ${pirate.crew}</p>
              <p class="pirate-bounty">ğŸ’° ${formatBounty(pirate.bounty)}à¸¿</p>
              <p class="pirate-rank">${rank.icon} ${rank.name}</p>
            </div>
          </div>
        `;
        
        // Hiá»ƒn thá»‹ stats
        statsSection.style.display = 'block';
        document.getElementById('statBounty').textContent = formatBounty(pirate.bounty) + 'à¸¿';
        document.getElementById('statRank').textContent = rank.name;
        document.getElementById('statCrew').textContent = pirate.crew;
        document.getElementById('statRanking').textContent = '#' + ranking + '/' + pirates.length;
      } else {
        pirateContainer.innerHTML = `
          <div class="no-pirate-card">
            <div class="no-pirate-icon">ğŸ´â€â˜ ï¸</div>
            <p>Báº¡n chÆ°a Ä‘Æ°á»£c liÃªn káº¿t vá»›i háº£i táº·c nÃ o</p>
            <small>LiÃªn há»‡ Admin Ä‘á»ƒ Ä‘Æ°á»£c gÃ¡n háº£i táº·c</small>
          </div>
        `;
      }
    }

    // Format bounty
    function formatBounty(bounty) {
      if (bounty >= 1000000) return (bounty / 1000000).toFixed(1) + 'M';
      if (bounty >= 1000) return (bounty / 1000).toFixed(1) + 'K';
      return bounty.toString();
    }

    // Modal functions
    function openModal(id) {
      document.getElementById(id).classList.add('active');
    }
    
    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    // Äá»•i máº­t kháº©u
    function changePassword() {
      openModal('changePasswordModal');
    }

    function handleChangePassword(event) {
      event.preventDefault();
      
      const currentPass = document.getElementById('currentPassword').value;
      const newPass = document.getElementById('newPassword').value;
      const confirmPass = document.getElementById('confirmPassword').value;
      const errorEl = document.getElementById('passwordError');
      
      const user = getCurrentUser();
      
      if (currentPass !== user.password) {
        errorEl.textContent = 'Máº­t kháº©u hiá»‡n táº¡i khÃ´ng Ä‘Ãºng!';
        return;
      }
      
      if (newPass !== confirmPass) {
        errorEl.textContent = 'Máº­t kháº©u má»›i khÃ´ng khá»›p!';
        return;
      }
      
      if (newPass.length < 4) {
        errorEl.textContent = 'Máº­t kháº©u má»›i pháº£i cÃ³ Ã­t nháº¥t 4 kÃ½ tá»±!';
        return;
      }
      
      // Cáº­p nháº­t máº­t kháº©u
      const accounts = JSON.parse(localStorage.getItem('onePieceAccounts') || '[]');
      const accountIndex = accounts.findIndex(a => a.username === user.username);
      
      if (accountIndex !== -1) {
        accounts[accountIndex].password = newPass;
        localStorage.setItem('onePieceAccounts', JSON.stringify(accounts));
        
        // Cáº­p nháº­t current user
        user.password = newPass;
        setCurrentUser(user);
        
        closeModal('changePasswordModal');
        showToast('success', 'âœ… Äá»•i máº­t kháº©u thÃ nh cÃ´ng!');
        document.getElementById('changePasswordForm').reset();
      }
    }

    // Xem báº£ng xáº¿p háº¡ng
    function viewLeaderboard() {
      window.location.href = 'index.html';
    }

    // ==================== AVATAR FUNCTIONS ====================
    
    let tempAvatarData = null;
    
    // Má»Ÿ modal Ä‘á»•i avatar
    function openAvatarModal() {
      const user = getCurrentUser();
      const preview = document.getElementById('avatarPreview');
      
      // Hiá»ƒn thá»‹ avatar hiá»‡n táº¡i
      if (user.avatar) {
        preview.innerHTML = `<img src="${user.avatar}" alt="Avatar">`;
      } else {
        preview.textContent = 'ğŸ‘¤';
      }
      
      tempAvatarData = null;
      document.getElementById('avatarUrlInput').value = '';
      openModal('changeAvatarModal');
    }
    
    // Preview avatar tá»« file
    function previewAvatar(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      // Kiá»ƒm tra kÃ­ch thÆ°á»›c file (max 2MB)
      if (file.size > 2 * 1024 * 1024) {
        showToast('error', 'âŒ áº¢nh quÃ¡ lá»›n! Tá»‘i Ä‘a 2MB');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        tempAvatarData = e.target.result;
        document.getElementById('avatarPreview').innerHTML = `<img src="${tempAvatarData}" alt="Preview">`;
        document.getElementById('avatarUrlInput').value = '';
      };
      reader.readAsDataURL(file);
    }
    
    // Preview avatar tá»« URL
    function previewAvatarUrl() {
      const url = document.getElementById('avatarUrlInput').value.trim();
      if (!url) return;
      
      // Test xem URL cÃ³ há»£p lá»‡ khÃ´ng
      const img = new Image();
      img.onload = function() {
        tempAvatarData = url;
        document.getElementById('avatarPreview').innerHTML = `<img src="${url}" alt="Preview">`;
      };
      img.onerror = function() {
        showToast('error', 'âŒ KhÃ´ng thá»ƒ táº£i áº£nh tá»« URL nÃ y!');
      };
      img.src = url;
    }
    
    // LÆ°u avatar
    function saveAvatar() {
      if (!tempAvatarData) {
        showToast('error', 'âŒ Vui lÃ²ng chá»n áº£nh trÆ°á»›c!');
        return;
      }
      
      // Láº¥y user hiá»‡n táº¡i tá»« localStorage trá»±c tiáº¿p
      const currentUserData = JSON.parse(localStorage.getItem('onePieceCurrentUser') || '{}');
      currentUserData.avatar = tempAvatarData;
      
      // Cáº­p nháº­t trong accounts
      const accounts = JSON.parse(localStorage.getItem('onePieceAccounts') || '[]');
      const accountIndex = accounts.findIndex(a => a.username === currentUserData.username);
      
      if (accountIndex !== -1) {
        accounts[accountIndex].avatar = tempAvatarData;
        localStorage.setItem('onePieceAccounts', JSON.stringify(accounts));
      }
      
      // Cáº­p nháº­t current user trong localStorage
      localStorage.setItem('onePieceCurrentUser', JSON.stringify(currentUserData));
      
      // ===== Äá»’NG Bá»˜ AVATAR CHO PIRATE LIÃŠN Káº¾T =====
      if (currentUserData.pirateId) {
        const piratesData = JSON.parse(localStorage.getItem('onePiecePirates') || '[]');
        const pirateIndex = piratesData.findIndex(p => p.name === currentUserData.pirateId);
        
        if (pirateIndex !== -1) {
          piratesData[pirateIndex].image = tempAvatarData;
          localStorage.setItem('onePiecePirates', JSON.stringify(piratesData));
          
          // Cáº­p nháº­t timestamp Ä‘á»ƒ khÃ´ng bá»‹ Firebase ghi Ä‘Ã¨
          localStorage.setItem('lastLocalUpdate', Date.now().toString());
          
          // Cáº­p nháº­t biáº¿n pirates global (dÃ¹ng trong firebase-sync.js)
          if (typeof pirates !== 'undefined') {
            pirates = piratesData;
          }
          
          // Sync lÃªn Firebase náº¿u Ä‘ang báº­t
          if (typeof syncToFirebase === 'function' && typeof syncEnabled !== 'undefined' && syncEnabled) {
            syncToFirebase();
            showToast('success', 'âœ… Äá»•i avatar vÃ  Ä‘á»“ng bá»™ lÃªn cloud thÃ nh cÃ´ng!');
          } else {
            showToast('success', 'âœ… Äá»•i avatar thÃ nh cÃ´ng!');
          }
          
          // Cáº­p nháº­t UI pháº§n háº£i táº·c
          const pirateAvatarEl = document.getElementById('pirateAvatarDisplay');
          if (pirateAvatarEl) {
            pirateAvatarEl.innerHTML = `<img src="${tempAvatarData}" alt="Pirate Avatar">`;
          }
        }
      }
      
      // Cáº­p nháº­t UI avatar profile
      document.getElementById('userAvatar').innerHTML = `<img src="${tempAvatarData}" alt="Avatar">`;
      
      closeModal('changeAvatarModal');
    }

    // Toast notification
    function showToast(type, message) {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      container.appendChild(toast);
      
      setTimeout(() => toast.remove(), 3000);
    }
  </script>
</body>
</html>
