<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ‘¤ Trang CÃ¡ NhÃ¢n - One Piece Bounty</title>
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/user.css">
  <link rel="stylesheet" href="css/user-rewards-display.css">
  <link rel="stylesheet" href="css/user-weapons-enhanced.css">
</head>
<body>
  <div class="user-container">
    <!-- Header -->
    <header class="user-header">
      <div class="header-left">
        <a href="index.html" class="back-link">â† Quay láº¡i</a>
        <h1>ğŸ‘¤ TRANG CÃ NHÃ‚N</h1>
      </div>
      <div class="header-right">
        <button class="logout-btn" onclick="logout()">ğŸšª ÄÄƒng Xuáº¥t</button>
      </div>
    </header>

    <!-- User Info Section -->
    <main class="user-main">
      <!-- Profile Card -->
      <section class="profile-section">
        <div class="profile-card">
          <div class="profile-avatar-wrapper">
            <div class="profile-avatar" id="userAvatar">
              ğŸ‘¤
            </div>
            <button class="change-avatar-btn" onclick="openAvatarModal()" title="Äá»•i Avatar">
              ğŸ“·
            </button>
          </div>
          <div class="profile-info">
            <h2 id="userName">Äang táº£i...</h2>
            <p class="user-email" id="userEmail">...</p>
            <div class="user-badges">
              <span class="badge badge-role" id="userRole">User</span>
              <span class="badge badge-status" id="userStatus">Active</span>
            </div>
            <p class="user-joined">ğŸ“… Tham gia: <span id="userJoined">...</span></p>
          </div>
        </div>
      </section>

      <!-- Linked Pirate Section -->
      <section class="pirate-section">
        <h3>ğŸ´â€â˜ ï¸ Háº£i Táº·c Cá»§a Báº¡n</h3>
        <div class="linked-pirate" id="linkedPirate">
          <p class="no-pirate">Äang táº£i thÃ´ng tin...</p>
        </div>
      </section>

      <!-- Stats Section -->
      <section class="stats-section" id="pirateStats" style="display: none;">
        <h3>ğŸ“Š Thá»‘ng KÃª</h3>
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-icon">ğŸ’°</div>
            <div class="stat-value" id="statBounty">0à¸¿</div>
            <div class="stat-label">Tiá»n Truy NÃ£</div>
          </div>
          <div class="stat-item">
            <div class="stat-icon">ğŸ†</div>
            <div class="stat-value" id="statRank">-</div>
            <div class="stat-label">Cáº¥p Äá»™</div>
          </div>
          <div class="stat-item">
            <div class="stat-icon">âš”ï¸</div>
            <div class="stat-value" id="statCrew">-</div>
            <div class="stat-label">BÄƒng NhÃ³m</div>
          </div>
          <div class="stat-item">
            <div class="stat-icon">ğŸ“ˆ</div>
            <div class="stat-value" id="statRanking">-</div>
            <div class="stat-label">Xáº¿p Háº¡ng</div>
          </div>
        </div>
      </section>

      <!-- Reward Exchange Section -->
      <section class="rewards-section" id="rewardsSection" style="display: none;">
        <h3>ğŸ Äá»•i Pháº§n ThÆ°á»Ÿng</h3>
        <div class="rewards-info">
          <p>Sá»­ dá»¥ng Bounty cá»§a báº¡n Ä‘á»ƒ Ä‘á»•i cÃ¡c pháº§n thÆ°á»Ÿng Ä‘áº·c biá»‡t!</p>
          <p class="current-bounty">ğŸ’° Bounty hiá»‡n táº¡i: <strong id="currentBountyForReward">0à¸¿</strong></p>
        </div>
        <div class="rewards-grid" id="rewardsGrid">
          <p style="text-align: center; grid-column: 1/-1;">Äang táº£i pháº§n thÆ°á»Ÿng...</p>
        </div>
      </section>

      <!-- Exchange History Section -->
      <section class="history-section" id="historySection" style="display: none;">
        <h3>ğŸ“œ Lá»‹ch Sá»­ Äá»•i ThÆ°á»Ÿng</h3>
        <div class="history-list" id="historyList">
          <p style="text-align: center;">ChÆ°a cÃ³ lá»‹ch sá»­ Ä‘á»•i thÆ°á»Ÿng</p>
        </div>
      </section>

      <!-- Weapons Inventory -->
      <section class="inventory-section">
        <h3>âš”ï¸ Kho VÅ© KhÃ­</h3>
        <div class="weapons-grid" id="weaponsGrid">
          <p style="text-align: center; color: #95a5a6;">ChÆ°a cÃ³ vÅ© khÃ­ nÃ o</p>
        </div>
      </section>

      <!-- Quick Actions -->
      <section class="actions-section">
        <h3>âš¡ HÃ nh Äá»™ng Nhanh</h3>
        <div class="actions-grid">
          <a href="index.html" class="action-btn">
            <span class="action-icon">ğŸ </span>
            <span class="action-text">Trang Chá»§</span>
          </a>
          <a href="battle.html" class="action-btn">
            <span class="action-icon">âš”ï¸</span>
            <span class="action-text">Chiáº¿n TrÆ°á»ng Boss</span>
          </a>
          <button class="action-btn" onclick="viewLeaderboard()">
            <span class="action-icon">ğŸ…</span>
            <span class="action-text">Báº£ng Xáº¿p Háº¡ng</span>
          </button>
          <button class="action-btn" onclick="viewRewards()">
            <span class="action-icon">ğŸ</span>
            <span class="action-text">Äá»•i ThÆ°á»Ÿng</span>
          </button>
          <button class="action-btn" onclick="changePassword()">
            <span class="action-icon">ğŸ”‘</span>
            <span class="action-text">Äá»•i Máº­t Kháº©u</span>
          </button>
        </div>
      </section>

      <!-- Quest Filter Section -->
      <section class="quest-filter-section">
        <h3>ğŸ“š Chá»n Nhiá»‡m Vá»¥</h3>
        <div class="filter-container">
          <div class="filter-group">
            <label>ğŸ“ Chá»n Lá»›p:</label>
            <select id="gradeFilter" class="filter-select">
              <option value="">-- Chá»n lá»›p --</option>
              <option value="3">Lá»›p 3</option>
              <option value="4">Lá»›p 4</option>
              <option value="5">Lá»›p 5</option>
            </select>
          </div>
          <div class="filter-group">
            <label>ğŸ“– Chá»n MÃ´n:</label>
            <select id="subjectFilter" class="filter-select">
              <option value="">-- Chá»n mÃ´n --</option>
              <option value="tin-hoc">Tin há»c</option>
              <option value="cong-nghe">CÃ´ng nghá»‡</option>
            </select>
          </div>
          <button class="btn-filter" onclick="loadQuestsByFilter()">ğŸ” Xem Nhiá»‡m Vá»¥</button>
        </div>
      </section>

      <!-- Regular Quests Section -->
      <section class="regular-quests-section" style="display: none;">
        <h3>ğŸ“ Nhiá»‡m Vá»¥ ThÆ°á»ng (3 láº§n/ngÃ y)</h3>
        <div class="quests-list" id="regularQuestsList"></div>
      </section>

      <!-- Special Quests Section -->
      <section class="special-quests-section" style="display: none;">
        <h3>ğŸ“¸ Nhiá»‡m Vá»¥ Äáº·c Biá»‡t (1 láº§n/thÃ¡ng)</h3>
        <div class="quests-list" id="specialQuestsList"></div>
      </section>

      <!-- My Submissions Section -->
      <section class="my-submissions-section">
        <h3>ğŸ“‹ BÃ i Ná»™p Cá»§a TÃ´i</h3>
        <div class="submissions-list" id="mySubmissionsList">
          <p class="loading">Äang táº£i bÃ i ná»™p...</p>
        </div>
      </section>
    </main>

    <!-- Footer -->
    <footer class="user-footer">
      <p>âš“ One Piece Bounty System</p>
    </footer>
  </div>

  <!-- Change Password Modal -->
  <div class="modal-overlay" id="changePasswordModal">
    <div class="modal">
      <div class="modal-header">
        <h3>ğŸ”‘ Äá»•i Máº­t Kháº©u</h3>
        <button class="close-btn" onclick="closeModal('changePasswordModal')">&times;</button>
      </div>
      <div class="modal-body">
        <form id="changePasswordForm" onsubmit="handleChangePassword(event)">
          <div class="form-group">
            <label>Máº­t kháº©u hiá»‡n táº¡i</label>
            <input type="password" id="currentPassword" required>
          </div>
          <div class="form-group">
            <label>Máº­t kháº©u má»›i</label>
            <input type="password" id="newPassword" required minlength="4">
          </div>
          <div class="form-group">
            <label>XÃ¡c nháº­n máº­t kháº©u má»›i</label>
            <input type="password" id="confirmPassword" required>
          </div>
          <p class="error-message" id="passwordError"></p>
          <div class="form-actions">
            <button type="button" class="btn-cancel" onclick="closeModal('changePasswordModal')">Há»§y</button>
            <button type="submit" class="btn-save">Äá»•i Máº­t Kháº©u</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Do Quiz Modal -->
  <div class="modal-overlay" id="doQuizModal">
    <div class="modal modal-lg">
      <div class="modal-header">
        <h3 id="quizModalTitle">ğŸ“ LÃ m Nhiá»‡m Vá»¥</h3>
        <button class="close-btn" onclick="closeModal('doQuizModal')">&times;</button>
      </div>
      <div class="modal-body">
        <form id="doQuizForm" onsubmit="handleSubmitQuiz(event)">
          <input type="hidden" id="quizQuestIndex">
          <input type="hidden" id="quizQuestTitle">
          
          <div class="quiz-info" style="background: rgba(52, 73, 94, 0.3); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
            <p><strong>ğŸ“ Nhiá»‡m vá»¥:</strong> <span id="quizQuestTitleDisplay"></span></p>
            <p style="margin-top: 5px;"><strong>ğŸ“š Sá»‘ cÃ¢u há»i:</strong> <span id="quizQuestionCount"></span></p>
            <p style="margin-top: 5px; color: #f39c12;"><strong>ğŸ’° Äiá»ƒm:</strong> +<span id="quizRewardPerQuestion"></span>à¸¿/Ä‘Ãºng | -<span id="quizPenaltyPerQuestion"></span>à¸¿/sai</p>
          </div>
          
          <div id="quizQuestionsContainer">
            <!-- Questions will be loaded here -->
          </div>
          
          <div class="form-actions">
            <button type="button" class="btn-cancel" onclick="closeModal('doQuizModal')">Há»§y</button>
            <button type="submit" class="btn-save">âœ… Ná»™p BÃ i</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Submit Quest Modal -->
  <div class="modal-overlay" id="submitQuestModal">
    <div class="modal">
      <div class="modal-header">
        <h3>ğŸ“¸ Ná»™p BÃ i</h3>
        <button class="close-btn" onclick="closeModal('submitQuestModal')">&times;</button>
      </div>
      <div class="modal-body">
        <form id="submitQuestForm" onsubmit="handleSubmitQuest(event)">
          <input type="hidden" id="submitQuestId">
          <input type="hidden" id="submitQuestTitle">
          
          <div class="form-group">
            <label>ğŸ“ Nhiá»‡m vá»¥</label>
            <p id="submitQuestTitleDisplay" style="font-weight: 600; color: #3498db;"></p>
          </div>
          
          <div class="form-group">
            <label>ğŸ“‹ YÃªu cáº§u</label>
            <p id="submitQuestRequirements" style="white-space: pre-wrap; background: rgba(52, 73, 94, 0.3); padding: 10px; border-radius: 5px;"></p>
          </div>
          
          <div class="form-group">
            <label>ğŸ–¼ï¸ Upload hÃ¬nh áº£nh bÃ i lÃ m</label>
            <input type="file" id="submitQuestImages" accept="image/*" multiple required>
            <small style="color: #95a5a6; display: block; margin-top: 5px;">CÃ³ thá»ƒ chá»n nhiá»u áº£nh</small>
          </div>
          
          <div id="imagePreviewContainer" style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
            <!-- Preview images will appear here -->
          </div>
          
          <div class="form-actions">
            <button type="button" class="btn-cancel" onclick="closeModal('submitQuestModal')">Há»§y</button>
            <button type="submit" class="btn-save">ğŸ“¤ Ná»™p BÃ i</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Change Avatar Modal -->
  <div class="modal-overlay" id="changeAvatarModal">
    <div class="modal avatar-modal">
      <div class="modal-header">
        <h3>ğŸ“· Äá»•i Avatar</h3>
        <button class="close-btn" onclick="closeModal('changeAvatarModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="avatar-preview-container">
          <div class="avatar-preview" id="avatarPreview">ğŸ‘¤</div>
        </div>
        
        <div class="avatar-options">
          <div class="avatar-option-group">
            <h4>ğŸ“¤ Táº£i áº£nh lÃªn</h4>
            <input type="file" id="avatarFileInput" accept="image/*" onchange="previewAvatar(event)" style="display: none;">
            <button class="avatar-upload-btn" onclick="document.getElementById('avatarFileInput').click()">
              Chá»n áº£nh tá»« mÃ¡y
            </button>
          </div>
          
          <div class="avatar-option-group">
            <h4>ğŸ”— Hoáº·c nháº­p URL</h4>
            <input type="text" id="avatarUrlInput" placeholder="https://example.com/avatar.jpg" onchange="previewAvatarUrl()">
          </div>
        </div>
        
        <div class="form-actions">
          <button type="button" class="btn-cancel" onclick="closeModal('changeAvatarModal')">Há»§y</button>
          <button type="button" class="btn-save" onclick="saveAvatar()">LÆ°u Avatar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script src="js/firebase-config.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/pirates.js"></script>
  <script src="js/firebase-sync.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/user-quests.js"></script>
  <script>
    // Kiá»ƒm tra Ä‘Äƒng nháº­p
    document.addEventListener('DOMContentLoaded', function() {
      const user = getCurrentUser();
      
      if (!user) {
        window.location.href = 'index.html';
        return;
      }
      
      loadUserProfile(user);
    });

    // Load thÃ´ng tin user
    function loadUserProfile(user) {
      // Láº¥y thÃ´ng tin rank tá»« pirate liÃªn káº¿t
      const pirates = JSON.parse(localStorage.getItem('onePiecePirates') || '[]');
      const linkedPirate = pirates.find(p => p.name === user.pirateId);
      let rankColor = '#f39c12'; // MÃ u máº·c Ä‘á»‹nh
      let rankType = ''; // Class rank
      
      if (linkedPirate) {
        const rank = getRankByBounty(linkedPirate.bounty);
        rankColor = rank.color;
        rankType = rank.type;
      }
      
      // ThÃ´ng tin cÆ¡ báº£n
      const userNameEl = document.getElementById('userName');
      userNameEl.textContent = user.username;
      userNameEl.className = rankType; // ThÃªm class rank cho gradient animation
      // Chá»‰ set mÃ u náº¿u khÃ´ng cÃ³ rank (fallback)
      if (!rankType) {
        userNameEl.style.color = rankColor;
        userNameEl.style.textShadow = `0 0 10px ${rankColor}40`;
      }
      
      document.getElementById('userEmail').textContent = user.email || 'ChÆ°a cÃ³ email';
      document.getElementById('userRole').textContent = user.role === 'admin' ? 'ğŸ‘‘ Admin' : 'ğŸ´â€â˜ ï¸ User';
      document.getElementById('userRole').className = 'badge badge-role ' + user.role;
      document.getElementById('userStatus').textContent = user.status === 'active' ? 'âœ… Hoáº¡t Ä‘á»™ng' : 'â¸ï¸ ' + user.status;
      document.getElementById('userJoined').textContent = user.createdAt || 'KhÃ´ng rÃµ';

      // Hiá»ƒn thá»‹ avatar - Æ°u tiÃªn láº¥y tá»« pirate liÃªn káº¿t
      const avatarEl = document.getElementById('userAvatar');
      if (linkedPirate && linkedPirate.image) {
        avatarEl.innerHTML = `<img src="${linkedPirate.image}" alt="Avatar">`;
      } else if (user.avatar) {
        avatarEl.innerHTML = `<img src="${user.avatar}" alt="Avatar">`;
      } else {
        avatarEl.textContent = user.role === 'admin' ? 'ğŸ‘‘' : 'ğŸ‘¤';
      }

      // Load thÃ´ng tin háº£i táº·c liÃªn káº¿t
      loadLinkedPirate(user);
      
      // Load pirates vÃ  attempts tá»« Firebase trÆ°á»›c
      if (typeof loadPiratesFromFirebase === 'function') {
        loadPiratesFromFirebase().then(() => {
          // Reload profile vá»›i dá»¯ liá»‡u má»›i
          loadLinkedPirate(user);
        });
      }
      if (typeof loadAttemptsFromFirebase === 'function') {
        loadAttemptsFromFirebase();
      }
      
      // KhÃ´ng tá»± Ä‘á»™ng load - ngÆ°á»i dÃ¹ng pháº£i chá»n lá»›p/mÃ´n trÆ°á»›c
    }
    
    // Load bÃ i ná»™p sau khi trang load xong hoÃ n toÃ n
    window.addEventListener('load', function() {
      setTimeout(() => {
        if (typeof loadMySubmissions === 'function') {
          loadMySubmissions();
        }
      }, 1500);
    });

    // Load háº£i táº·c liÃªn káº¿t
    function loadLinkedPirate(user) {
      const pirateContainer = document.getElementById('linkedPirate');
      const statsSection = document.getElementById('pirateStats');
      const profileCard = document.querySelector('.profile-card');
      
      // Load pirates tá»« localStorage
      const savedPirates = localStorage.getItem('onePiecePirates');
      const pirates = savedPirates ? JSON.parse(savedPirates) : [];
      
      // TÃ¬m háº£i táº·c liÃªn káº¿t
      const pirate = pirates.find(p => p.name === user.pirateId);
      
      if (pirate) {
        const rank = getRankByBounty(pirate.bounty);
        const ranking = pirates.sort((a, b) => b.bounty - a.bounty).findIndex(p => p.name === pirate.name) + 1;
        
        // ThÃªm rank class vÃ o profile card
        if (profileCard) {
          profileCard.className = 'profile-card ' + rank.type;
        }
        
        // Hiá»ƒn thá»‹ thÃ´ng tin háº£i táº·c
        // Get completed rewards
        const exchanges = JSON.parse(localStorage.getItem('onePieceExchanges') || '[]');
        const completedExchanges = exchanges.filter(e => e.status === 'completed' && e.pirateName === pirate.name);
        const rewards = JSON.parse(localStorage.getItem('onePieceRewards') || '[]');
        
        let rewardsHTML = '';
        if (completedExchanges.length > 0) {
          const rewardsList = completedExchanges.map(exchange => {
            const reward = rewards.find(r => r.id === exchange.rewardId);
            return reward ? `<span class="mini-reward" title="${reward.name}">${reward.icon}</span>` : '';
          }).join('');
          rewardsHTML = `<div class="pirate-rewards">${rewardsList}</div>`;
        }
        
        pirateContainer.innerHTML = `
          <div class="pirate-card ${rank.type}">
            <div class="pirate-avatar" id="pirateAvatarDisplay">
              ${pirate.image ? `<img src="${pirate.image}" alt="${pirate.name}">` : rank.icon}
            </div>
            <div class="pirate-info">
              <h4>${pirate.name}</h4>
              <p class="pirate-crew">âš”ï¸ ${pirate.crew}</p>
              <p class="pirate-bounty">ğŸ’° ${formatBounty(pirate.bounty)}à¸¿</p>
              <p class="pirate-rank">${rank.icon} ${rank.name}</p>
              ${rewardsHTML}
            </div>
          </div>
        `;
        
        // Hiá»ƒn thá»‹ stats
        statsSection.style.display = 'block';
        document.getElementById('statBounty').textContent = formatBounty(pirate.bounty) + 'à¸¿';
        document.getElementById('statRank').textContent = rank.name;
        document.getElementById('statCrew').textContent = pirate.crew;
        document.getElementById('statRanking').textContent = '#' + ranking + '/' + pirates.length;
      } else {
        pirateContainer.innerHTML = `
          <div class="no-pirate-card">
            <div class="no-pirate-icon">ğŸ´â€â˜ ï¸</div>
            <p>Báº¡n chÆ°a Ä‘Æ°á»£c liÃªn káº¿t vá»›i háº£i táº·c nÃ o</p>
            <small>LiÃªn há»‡ Admin Ä‘á»ƒ Ä‘Æ°á»£c gÃ¡n háº£i táº·c</small>
          </div>
        `;
      }
    }

    // Format bounty
    function formatBounty(bounty) {
      if (bounty >= 1000000) return (bounty / 1000000).toFixed(1) + 'M';
      if (bounty >= 1000) return (bounty / 1000).toFixed(1) + 'K';
      return bounty.toString();
    }

    // Modal functions
    function openModal(id) {
      document.getElementById(id).classList.add('active');
    }
    
    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    // Äá»•i máº­t kháº©u
    function changePassword() {
      openModal('changePasswordModal');
    }

    function handleChangePassword(event) {
      event.preventDefault();
      
      const currentPass = document.getElementById('currentPassword').value;
      const newPass = document.getElementById('newPassword').value;
      const confirmPass = document.getElementById('confirmPassword').value;
      const errorEl = document.getElementById('passwordError');
      
      const user = getCurrentUser();
      
      if (currentPass !== user.password) {
        errorEl.textContent = 'Máº­t kháº©u hiá»‡n táº¡i khÃ´ng Ä‘Ãºng!';
        return;
      }
      
      if (newPass !== confirmPass) {
        errorEl.textContent = 'Máº­t kháº©u má»›i khÃ´ng khá»›p!';
        return;
      }
      
      if (newPass.length < 4) {
        errorEl.textContent = 'Máº­t kháº©u má»›i pháº£i cÃ³ Ã­t nháº¥t 4 kÃ½ tá»±!';
        return;
      }
      
      // Cáº­p nháº­t máº­t kháº©u
      const accounts = JSON.parse(localStorage.getItem('onePieceAccounts') || '[]');
      const accountIndex = accounts.findIndex(a => a.username === user.username);
      
      if (accountIndex !== -1) {
        accounts[accountIndex].password = newPass;
        localStorage.setItem('onePieceAccounts', JSON.stringify(accounts));
        
        // Cáº­p nháº­t current user
        user.password = newPass;
        setCurrentUser(user);
        
        closeModal('changePasswordModal');
        showToast('success', 'âœ… Äá»•i máº­t kháº©u thÃ nh cÃ´ng!');
        document.getElementById('changePasswordForm').reset();
      }
    }

    // Xem báº£ng xáº¿p háº¡ng
    function viewLeaderboard() {
      window.location.href = 'index.html';
    }

    // ==================== AVATAR FUNCTIONS ====================
    
    let tempAvatarData = null;
    
    // Má»Ÿ modal Ä‘á»•i avatar
    function openAvatarModal() {
      const user = getCurrentUser();
      const preview = document.getElementById('avatarPreview');
      
      // Hiá»ƒn thá»‹ avatar hiá»‡n táº¡i
      if (user.avatar) {
        preview.innerHTML = `<img src="${user.avatar}" alt="Avatar">`;
      } else {
        preview.textContent = 'ğŸ‘¤';
      }
      
      tempAvatarData = null;
      document.getElementById('avatarUrlInput').value = '';
      openModal('changeAvatarModal');
    }
    
    // Preview avatar tá»« file
    function previewAvatar(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      // Kiá»ƒm tra kÃ­ch thÆ°á»›c file (max 2MB)
      if (file.size > 2 * 1024 * 1024) {
        showToast('error', 'âŒ áº¢nh quÃ¡ lá»›n! Tá»‘i Ä‘a 2MB');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        tempAvatarData = e.target.result;
        document.getElementById('avatarPreview').innerHTML = `<img src="${tempAvatarData}" alt="Preview">`;
        document.getElementById('avatarUrlInput').value = '';
      };
      reader.readAsDataURL(file);
    }
    
    // Preview avatar tá»« URL
    function previewAvatarUrl() {
      const url = document.getElementById('avatarUrlInput').value.trim();
      if (!url) return;
      
      // Test xem URL cÃ³ há»£p lá»‡ khÃ´ng
      const img = new Image();
      img.onload = function() {
        tempAvatarData = url;
        document.getElementById('avatarPreview').innerHTML = `<img src="${url}" alt="Preview">`;
      };
      img.onerror = function() {
        showToast('error', 'âŒ KhÃ´ng thá»ƒ táº£i áº£nh tá»« URL nÃ y!');
      };
      img.src = url;
    }
    
    // LÆ°u avatar
    function saveAvatar() {
      if (!tempAvatarData) {
        showToast('error', 'âŒ Vui lÃ²ng chá»n áº£nh trÆ°á»›c!');
        return;
      }
      
      // Láº¥y user hiá»‡n táº¡i tá»« localStorage trá»±c tiáº¿p
      const currentUserData = JSON.parse(localStorage.getItem('onePieceCurrentUser') || '{}');
      currentUserData.avatar = tempAvatarData;
      
      // Cáº­p nháº­t trong accounts
      const accounts = JSON.parse(localStorage.getItem('onePieceAccounts') || '[]');
      const accountIndex = accounts.findIndex(a => a.username === currentUserData.username);
      
      if (accountIndex !== -1) {
        accounts[accountIndex].avatar = tempAvatarData;
        localStorage.setItem('onePieceAccounts', JSON.stringify(accounts));
      }
      
      // Cáº­p nháº­t current user trong localStorage
      localStorage.setItem('onePieceCurrentUser', JSON.stringify(currentUserData));
      
      // ===== Äá»’NG Bá»˜ AVATAR CHO PIRATE LIÃŠN Káº¾T =====
      if (currentUserData.pirateId) {
        const piratesData = JSON.parse(localStorage.getItem('onePiecePirates') || '[]');
        const pirateIndex = piratesData.findIndex(p => p.name === currentUserData.pirateId);
        
        if (pirateIndex !== -1) {
          piratesData[pirateIndex].image = tempAvatarData;
          localStorage.setItem('onePiecePirates', JSON.stringify(piratesData));
          
          // Cáº­p nháº­t timestamp Ä‘á»ƒ khÃ´ng bá»‹ Firebase ghi Ä‘Ã¨
          localStorage.setItem('lastLocalUpdate', Date.now().toString());
          
          // Cáº­p nháº­t biáº¿n pirates global (dÃ¹ng trong firebase-sync.js)
          if (typeof pirates !== 'undefined') {
            pirates = piratesData;
          }
          
          // Sync lÃªn Firebase náº¿u Ä‘ang báº­t
          if (typeof syncToFirebase === 'function' && typeof syncEnabled !== 'undefined' && syncEnabled) {
            syncToFirebase();
            showToast('success', 'âœ… Äá»•i avatar vÃ  Ä‘á»“ng bá»™ lÃªn cloud thÃ nh cÃ´ng!');
          } else {
            showToast('success', 'âœ… Äá»•i avatar thÃ nh cÃ´ng!');
          }
          
          // Cáº­p nháº­t UI pháº§n háº£i táº·c
          const pirateAvatarEl = document.getElementById('pirateAvatarDisplay');
          if (pirateAvatarEl) {
            pirateAvatarEl.innerHTML = `<img src="${tempAvatarData}" alt="Pirate Avatar">`;
          }
        }
      }
      
      // Cáº­p nháº­t UI avatar profile
      document.getElementById('userAvatar').innerHTML = `<img src="${tempAvatarData}" alt="Avatar">`;
      
      closeModal('changeAvatarModal');
    }

    // Toast notification
    function showToast(type, message) {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      container.appendChild(toast);
      
      setTimeout(() => toast.remove(), 3000);
    }

    // ===== REWARD EXCHANGE FUNCTIONS =====
    
    function viewRewards() {
      const rewardsSection = document.getElementById('rewardsSection');
      const historySection = document.getElementById('historySection');
      
      if (rewardsSection.style.display === 'none') {
        rewardsSection.style.display = 'block';
        historySection.style.display = 'block';
        loadRewards();
        loadExchangeHistory();
        rewardsSection.scrollIntoView({ behavior: 'smooth' });
      } else {
        rewardsSection.style.display = 'none';
        historySection.style.display = 'none';
      }
    }

    async function loadRewards() {
      const user = getCurrentUser();
      if (!user || !user.pirateId) {
        showToast('warning', 'âš ï¸ Báº¡n chÆ°a cÃ³ háº£i táº·c liÃªn káº¿t!');
        return;
      }

      const piratesData = JSON.parse(localStorage.getItem('onePiecePirates') || '[]');
      const pirate = piratesData.find(p => p.name === user.pirateId);
      
      if (!pirate) {
        showToast('error', 'âŒ KhÃ´ng tÃ¬m tháº¥y háº£i táº·c!');
        return;
      }

      // Update current bounty display
      document.getElementById('currentBountyForReward').textContent = pirate.bounty.toLocaleString() + 'à¸¿';

      // Load rewards from storage
      const rewards = JSON.parse(localStorage.getItem('onePieceRewards') || '[]');
      const activeRewards = rewards.filter(r => r.status === 'active');

      const rewardsGrid = document.getElementById('rewardsGrid');
      
      if (activeRewards.length === 0) {
        rewardsGrid.innerHTML = '<p style="text-align: center; grid-column: 1/-1;">Hiá»‡n chÆ°a cÃ³ pháº§n thÆ°á»Ÿng nÃ o</p>';
        return;
      }

      rewardsGrid.innerHTML = activeRewards.map(reward => {
        const canAfford = pirate.bounty >= reward.points;
        const typeColors = {
          normal: '#95a5a6',
          rare: '#3498db',
          epic: '#9b59b6',
          legendary: '#f39c12',
          secret: '#e74c3c'
        };
        
        const typeLabels = {
          normal: 'ThÆ°á»ng',
          rare: 'Hiáº¿m',
          epic: 'Sá»­ Thi',
          legendary: 'Huyá»n Thoáº¡i',
          secret: 'BÃ­ Máº­t'
        };

        return `
          <div class="reward-card ${!canAfford ? 'disabled' : ''}" style="border-color: ${typeColors[reward.type]}">
            <div class="reward-icon">${reward.icon || 'ğŸ'}</div>
            <div class="reward-type" style="background: ${typeColors[reward.type]}">${typeLabels[reward.type]}</div>
            <h4 class="reward-name">${reward.name}</h4>
            <p class="reward-description">${reward.description || 'Pháº§n thÆ°á»Ÿng Ä‘áº·c biá»‡t'}</p>
            <div class="reward-points">ğŸ’° ${reward.points.toLocaleString()}à¸¿</div>
            <button class="reward-btn ${!canAfford ? 'disabled' : ''}" 
                    onclick="exchangeReward('${reward.id}')"
                    ${!canAfford ? 'disabled' : ''}>
              ${canAfford ? 'ğŸ Äá»•i Ngay' : 'ğŸ”’ ChÆ°a Äá»§ Äiá»ƒm'}
            </button>
          </div>
        `;
      }).join('');
    }

    async function exchangeReward(rewardId) {
      const user = getCurrentUser();
      if (!user || !user.pirateId) {
        showToast('warning', 'âš ï¸ Báº¡n chÆ°a cÃ³ háº£i táº·c liÃªn káº¿t!');
        return;
      }

      const piratesData = JSON.parse(localStorage.getItem('onePiecePirates') || '[]');
      const pirateIndex = piratesData.findIndex(p => p.name === user.pirateId);
      
      if (pirateIndex === -1) {
        showToast('error', 'âŒ KhÃ´ng tÃ¬m tháº¥y háº£i táº·c!');
        return;
      }

      const pirate = piratesData[pirateIndex];
      const rewards = JSON.parse(localStorage.getItem('onePieceRewards') || '[]');
      const reward = rewards.find(r => r.id === rewardId);

      if (!reward) {
        showToast('error', 'âŒ KhÃ´ng tÃ¬m tháº¥y pháº§n thÆ°á»Ÿng!');
        return;
      }

      if (pirate.bounty < reward.points) {
        showToast('warning', 'âš ï¸ Báº¡n khÃ´ng Ä‘á»§ Bounty!');
        return;
      }

      if (!confirm(`XÃ¡c nháº­n Ä‘á»•i "${reward.name}" vá»›i ${reward.points.toLocaleString()}à¸¿?`)) {
        return;
      }

      // Deduct points
      piratesData[pirateIndex].bounty -= reward.points;
      localStorage.setItem('onePiecePirates', JSON.stringify(piratesData));

      // Create exchange record
      const exchanges = JSON.parse(localStorage.getItem('onePieceExchanges') || '[]');
      const newExchange = {
        id: Date.now().toString(),
        rewardId: reward.id,
        pirateName: pirate.name,
        points: reward.points,
        timestamp: new Date().toISOString(),
        status: 'pending'
      };
      exchanges.push(newExchange);
      localStorage.setItem('onePieceExchanges', JSON.stringify(exchanges));

      // Sync to Firebase
      if (typeof database !== 'undefined' && database) {
        try {
          await database.ref('sharedData/pirates').set(piratesData);
          await database.ref('sharedData/exchanges').set(exchanges);
        } catch (error) {
          console.error('Sync error:', error);
        }
      }

      showToast('success', 'âœ… Äá»•i thÆ°á»Ÿng thÃ nh cÃ´ng! Chá» admin duyá»‡t.');
      loadRewards();
      loadExchangeHistory();
      
      // Refresh pirate info
      loadPirateInfo();
    }

    async function loadExchangeHistory() {
      const user = getCurrentUser();
      if (!user || !user.pirateId) return;

      const exchanges = JSON.parse(localStorage.getItem('onePieceExchanges') || '[]');
      const rewards = JSON.parse(localStorage.getItem('onePieceRewards') || '[]');
      
      const myExchanges = exchanges.filter(e => e.pirateName === user.pirateId)
                                   .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

      const historyList = document.getElementById('historyList');
      
      if (myExchanges.length === 0) {
        historyList.innerHTML = '<p style="text-align: center;">Báº¡n chÆ°a cÃ³ lá»‹ch sá»­ Ä‘á»•i thÆ°á»Ÿng</p>';
        return;
      }

      historyList.innerHTML = myExchanges.map(ex => {
        const reward = rewards.find(r => r.id === ex.rewardId);
        const date = new Date(ex.timestamp);
        const formattedDate = date.toLocaleDateString('vi-VN') + ' ' + date.toLocaleTimeString('vi-VN');
        
        const statusInfo = {
          pending: { text: 'Chá» Duyá»‡t', color: '#f39c12', icon: 'â³' },
          completed: { text: 'HoÃ n ThÃ nh', color: '#27ae60', icon: 'âœ…' },
          cancelled: { text: 'ÄÃ£ Há»§y', color: '#e74c3c', icon: 'âŒ' }
        };
        
        const status = statusInfo[ex.status] || statusInfo.pending;

        return `
          <div class="history-item">
            <div class="history-header">
              <span class="history-reward">${reward?.icon || 'ğŸ'} ${reward?.name || 'N/A'}</span>
              <span class="history-status" style="color: ${status.color}">${status.icon} ${status.text}</span>
            </div>
            <div class="history-details">
              <span>ğŸ’° ${ex.points.toLocaleString()}à¸¿</span>
              <span>ğŸ“… ${formattedDate}</span>
            </div>
          </div>
        `;
      }).join('');
    }

    // ===== WEAPONS INVENTORY FUNCTIONS =====
    
    async function loadWeaponsInventory() {
      const user = getCurrentUser();
      if (!user || !user.pirateId) return;

      const userWeapons = JSON.parse(localStorage.getItem('onePieceUserWeapons') || '{}');
      const myWeapons = userWeapons[user.pirateId] || [];
      
      const container = document.getElementById('weaponsGrid');
      
      if (myWeapons.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #95a5a6; padding: 40px; font-size: 16px;">ğŸ—¡ï¸ ChÆ°a cÃ³ vÅ© khÃ­ nÃ o. HÃ£y Ä‘Ã¡nh boss Ä‘á»ƒ nháº­n vÅ© khÃ­!</p>';
        return;
      }

      // Mapping tiáº¿ng Viá»‡t
      const typeNames = {
        'sword': 'âš”ï¸ Kiáº¿m',
        'gun': 'ğŸ”« SÃºng',
        'bow': 'ğŸ¹ Cung',
        'staff': 'ğŸ”® Gáº­y',
        'hammer': 'ğŸ”¨ BÃºa',
        'spear': 'ğŸ—¡ï¸ ThÆ°Æ¡ng',
        'axe': 'ğŸª“ RÃ¬u'
      };

      const rarityNames = {
        'common': 'ThÆ°á»ng',
        'uncommon': 'KhÃ¡',
        'rare': 'Hiáº¿m',
        'epic': 'Sá»­ Thi',
        'legendary': 'Huyá»n Thoáº¡i',
        'mythic': 'Tháº§n Thoáº¡i'
      };

      container.innerHTML = myWeapons.map(weapon => {
        const stats = [];
        if (weapon.atk > 0) stats.push(`<div class="weapon-stat"><span class="stat-icon">ğŸ’ª</span> <span class="stat-label">ATK:</span> <strong>+${weapon.atk}%</strong></div>`);
        if (weapon.def > 0) stats.push(`<div class="weapon-stat"><span class="stat-icon">ğŸ›¡ï¸</span> <span class="stat-label">DEF:</span> <strong>+${weapon.def}</strong></div>`);
        if (weapon.hp > 0) stats.push(`<div class="weapon-stat"><span class="stat-icon">â¤ï¸</span> <span class="stat-label">HP:</span> <strong>+${weapon.hp}</strong></div>`);
        if (weapon.crit > 0) stats.push(`<div class="weapon-stat"><span class="stat-icon">âš¡</span> <span class="stat-label">Crit:</span> <strong>+${weapon.crit}%</strong></div>`);

        const weaponLevel = weapon.level || 1;
        const levelBadge = weaponLevel > 1 ? `<div class="level-badge">â­ Level ${weaponLevel}</div>` : '';

        return `
          <div class="weapon-card ${weapon.rarity} ${weapon.equipped ? 'equipped' : ''}" onclick="toggleEquipWeapon('${weapon.instanceId}')">
            ${weapon.equipped ? '<div class="equipped-badge">âœ… Äang DÃ¹ng</div>' : ''}
            ${levelBadge}
            <div class="weapon-header">
              <div class="weapon-icon">${weapon.icon}</div>
              <div class="weapon-info">
                <div class="weapon-name">${weapon.name}</div>
                <div class="weapon-type">${typeNames[weapon.type] || weapon.type}</div>
              </div>
            </div>
            <div class="weapon-rarity ${weapon.rarity}">${rarityNames[weapon.rarity] || weapon.rarity}</div>
            <div class="weapon-stats">
              ${stats.join('')}
            </div>
            <div class="weapon-actions" onclick="event.stopPropagation()">
              ${weapon.equipped 
                ? `<button class="weapon-btn unequip-btn" onclick="toggleEquipWeapon('${weapon.instanceId}')">âŒ Gá»¡ Xuá»‘ng</button>`
                : `<button class="weapon-btn equip-btn" onclick="toggleEquipWeapon('${weapon.instanceId}')">âš”ï¸ Trang Bá»‹</button>`
              }
            </div>
          </div>
        `;
      }).join('');
    }

    async function toggleEquipWeapon(instanceId) {
      const user = getCurrentUser();
      if (!user || !user.pirateId) return;

      let userWeapons = JSON.parse(localStorage.getItem('onePieceUserWeapons') || '{}');
      const myWeapons = userWeapons[user.pirateId] || [];
      
      const weaponIndex = myWeapons.findIndex(w => w.instanceId === instanceId);
      if (weaponIndex === -1) return;

      const weapon = myWeapons[weaponIndex];
      
      if (weapon.equipped) {
        // Unequip
        weapon.equipped = false;
        showToast('info', `âŒ ÄÃ£ gá»¡ ${weapon.name}`);
      } else {
        // Unequip all other weapons first
        myWeapons.forEach(w => w.equipped = false);
        // Equip this weapon
        weapon.equipped = true;
        showToast('success', `âœ… ÄÃ£ trang bá»‹ ${weapon.name}!`);
      }

      userWeapons[user.pirateId] = myWeapons;
      localStorage.setItem('onePieceUserWeapons', JSON.stringify(userWeapons));
      
      // Sync to Firebase
      if (typeof database !== 'undefined' && database) {
        try {
          await database.ref('sharedData/userWeapons').set(userWeapons);
        } catch (error) {
          console.error('Sync error:', error);
        }
      }

      loadWeaponsInventory();
    }

    // Load weapons on page load
    window.addEventListener('DOMContentLoaded', () => {
      loadWeaponsInventory();
    });
  </script>
</body>
</html>
